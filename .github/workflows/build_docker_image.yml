name: Build Docker Image

on:
  push:
    branches: ["main"]

jobs:

  build:

    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
    - name: 'Checkout GitHub Action'
      uses: actions/checkout@main

    - name: 'Login to GitHub Container Registry'
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{github.actor}}
        password: ${{secrets.GITHUB_TOKEN}}
    
    - name: Build the Docker image
      run: |
        IMAGE=ghcr.io/${{github.repository}}
        IMAGE=$(echo $IMAGE | tr '[A-Z]' '[a-z]')
        echo IMAGE: $IMAGE
        docker build . --file Dockerfile --no-cache -t $IMAGE --label CI_COMMIT_SHA=${{github.sha}} --tag $IMAGE:latest
        docker push $IMAGE:latest


  build_raspberrypi:

    runs-on: [self-hosted, Linux, ARM64, raspberrypi]

    permissions:
      contents: read
      packages: write

    steps:
    - name: 'Checkout GitHub Action'
      uses: actions/checkout@main

    - name: 'Login to GitHub Container Registry'
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{github.actor}}
        password: ${{secrets.GITHUB_TOKEN}}
    
    - name: Build the Docker image
      run: |
        IMAGE=ghcr.io/${{github.repository}}
        IMAGE=$(echo $IMAGE | tr '[A-Z]' '[a-z]')
        echo IMAGE: $IMAGE
        docker build . --file Dockerfile --no-cache -t $IMAGE --label CI_COMMIT_SHA=${{github.sha}} --tag $IMAGE:latest_raspi64
        docker push $IMAGE:latest_raspi64